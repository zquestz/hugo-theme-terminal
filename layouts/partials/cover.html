{{- $cover := false -}}
{{- $coverImg := false -}}
{{- $coverImgSmall := false -}}
{{- $autoCover := default $.Site.Params.autoCover false -}}
{{- $isFirstPost := .Scratch.Get "isFirstPost" | default false -}}
{{- $maxWidth := 800 -}}
{{- $mobileWidth := 600 -}}
{{- $skipResizePaths := $.Site.Params.skipResizePaths | default slice -}}

{{- if index .Params "cover" -}}
  {{- if .Resources.GetMatch .Params.Cover -}}
    {{- $coverImg = (.Resources.GetMatch .Params.Cover) -}}
  {{- else -}}
    {{- $cover = relURL .Params.Cover -}}
  {{- end -}}
{{- else if $.Site.Params.AutoCover -}}
  {{- if (not .Params.Cover) -}}
    {{- if .Resources.GetMatch "cover.*" -}}
      {{- $coverImg = .Resources.GetMatch "cover.*" -}}
    {{- end -}}
  {{- end -}}
{{- end -}}

{{- /* Resize image if it's a page resource and wider than maxWidth */ -}}
{{- /* Skip GIFs and paths in skipResizePaths config */ -}}
{{- if $coverImg -}}
  {{- $isGif := eq $coverImg.MediaType.SubType "gif" -}}
  {{- $inSkipList := false -}}
  {{- range $skipResizePaths -}}
    {{- if in $coverImg.RelPermalink . -}}
      {{- $inSkipList = true -}}
    {{- end -}}
  {{- end -}}
  {{- $skipResize := or $isGif $inSkipList -}}
  {{- if and (gt $coverImg.Width $mobileWidth) (not $skipResize) -}}
    {{- $coverImgSmall = $coverImg.Resize (printf "%dx q85 webp" $mobileWidth) -}}
  {{- end -}}
  {{- if and (gt $coverImg.Width $maxWidth) (not $skipResize) -}}
    {{- $coverImg = $coverImg.Resize (printf "%dx q85 webp" $maxWidth) -}}
  {{- end -}}
  {{- $cover = $coverImg.RelPermalink -}}
{{- end -}}

{{- if $cover }}
<div class="post-cover">
  <img src="{{ $cover }}"
    {{- if $coverImgSmall }} srcset="{{ $coverImgSmall.RelPermalink }} {{ $coverImgSmall.Width }}w, {{ $coverImg.RelPermalink }} {{ $coverImg.Width }}w" sizes="(max-width: 684px) 600px, 800px"{{- end }}
    alt="{{ .Title | plainify | default " " }}"
    title="{{ .Params.CoverCredit | plainify | default "Cover Image" }}"
    {{- if not $isFirstPost }} loading="lazy"{{- else }} fetchpriority="high"{{- end }}
    {{- if $coverImg }} width="{{ $coverImg.Width }}" height="{{ $coverImg.Height }}"{{- end }}
  />
</div>
{{- end -}}
